{#

  This file defines a .j2 template for HAProxy loadbalancer configuration file.

#}
# This file is generated by Ansible.
#
# Simple configuration for HTTP proxy listening on port 80 on all available
# interfaces and forwarding requests to a backend "appservers" containing all
# hosts from appservers group.

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /var/run/haproxy.sock level admin # This socket has to be exposed for Ansible haproxy module (on admin level)
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend loadbalancers
    bind *:{{ http_port }}
    mode http
    default_backend appservers

backend appservers
    mode http
    balance roundrobin
    option forwardfor
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    option httpchk GET /

{% for host in groups['app-{{ env }}'] %}
    server app{{ loop.index }} {{ hostvars[host].ansible_ssh_host }}:{{ hostvars[host].app_port }} check
{% endfor %}

listen stats *:{{ haproxy_stats_port }}
    stats enable
    stats uri /
    stats hide-version
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
